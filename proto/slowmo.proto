syntax = "proto3";
package slowmo;
option go_package = "github.com/kailun2047/slowmo/proto";

message CompileAndRunRequest {
    optional string source = 1; // Go source code from user.
}

message CompileAndRunResponse {
    oneof compile_and_run_oneof {
        CompilationError compile_error = 1;
        RuntimeError runtime_error = 2;
        ProbeEvent run_event = 3;
        RuntimeOutput runtime_output = 4;
        int32 num_cpu = 5;
    };
}

message CompilationError  {
    optional string error_message = 1;
}

message RuntimeError {
    optional string error_message = 1;
}

message RuntimeOutput {
    optional string output = 1;
}

message ProbeEvent {
    oneof probe_event_oneof {
        RunqStatusEvent runq_status_event = 1;
        DelayEvent delay_event = 2;
        ScheduleEvent schedule_event = 3;
    };
}

message RunqStatusEvent {
    optional int64 proc_id = 1;
    InterpretedPC current_pc = 2;
    repeated RunqEntry runq_entries = 3;
    RunqEntry runnext = 4;
}

message InterpretedPC {
    optional string file = 1;
    optional int32 line = 2;
    optional string func = 3;
}

message RunqEntry {
    optional int64 go_id = 1;
    InterpretedPC execution_context = 2;
}

message DelayEvent {
    optional int64 m_id = 1;
    optional int64 go_id = 2;
    InterpretedPC current_pc = 3;
}

message ScheduleEvent {
    optional int64 m_id = 1;
    ScheduleReason reason = 2;
    optional int64  proc_id = 3;
}

enum ScheduleReason {
    GOEXIT = 0;
    GOPARK = 1;
    MSTART = 2;
    OTHER = 20;
}

service SlowmoService {
    rpc CompileAndRun(CompileAndRunRequest) returns (stream CompileAndRunResponse);
}